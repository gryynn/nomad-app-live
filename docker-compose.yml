services:
  nomad-frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: nomad-frontend
    restart: unless-stopped
    networks:
      - traefik_proxy
    labels:
      - "traefik.enable=true"
      # Local (HTTPS via Traefik)
      - "traefik.http.routers.nomad-frontend.rule=Host(`nomad.green-lab.local`)"
      - "traefik.http.routers.nomad-frontend.entrypoints=websecure"
      - "traefik.http.routers.nomad-frontend.tls=true"
      # Public (Cloudflare Tunnel → HTTP)
      - "traefik.http.routers.nomad-frontend-public.rule=Host(`nomad.mgdesign.cloud`)"
      - "traefik.http.routers.nomad-frontend-public.entrypoints=web"
      # Service port
      - "traefik.http.services.nomad-frontend.loadbalancer.server.port=80"
    depends_on:
      - nomad-api

  nomad-api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: nomad-api
    restart: unless-stopped
    env_file: backend/.env
    networks:
      - traefik_proxy
    labels:
      - "traefik.enable=true"
      # Local (HTTPS via Traefik)
      - "traefik.http.routers.nomad-api.rule=Host(`nomad-api.green-lab.local`)"
      - "traefik.http.routers.nomad-api.entrypoints=websecure"
      - "traefik.http.routers.nomad-api.tls=true"
      # Public (Cloudflare Tunnel → HTTP)
      - "traefik.http.routers.nomad-api-public.rule=Host(`nomad-api.mgdesign.cloud`)"
      - "traefik.http.routers.nomad-api-public.entrypoints=web"
      # Service port
      - "traefik.http.services.nomad-api.loadbalancer.server.port=8400"

networks:
  traefik_proxy:
    external: true
